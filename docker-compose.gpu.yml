services:
  # æ¨¡å‹ä¸‹è¼‰æœå‹™ï¼ˆä¸€æ¬¡æ€§ï¼Œå®Œæˆå¾Œè‡ªå‹•æ¸…ç†ï¼‰
  model-downloader:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-face-swap-model-downloader
    volumes:
      - ./backend:/app
    command: >
      sh -c "
        if [ ! -f /app/models/inswapper_128.onnx ]; then
          echo 'ğŸ”„ æ­£åœ¨ä¸‹è¼‰ AI æ¨¡å‹æª”æ¡ˆ...'
          mkdir -p /app/models
          
          # å˜—è©¦ç¬¬ä¸€å€‹ä¸‹è¼‰æº
          echo 'ğŸ“¥ å˜—è©¦å¾ HuggingFace ä¸‹è¼‰...'
          if wget --timeout=60 --tries=3 --progress=bar:force:noscroll -O /app/models/inswapper_128.onnx 'https://huggingface.co/spaces/mkrzyzan/face-swap/resolve/main/inswapper_128.onnx'; then
            # å®‰å…¨ç²å–æª”æ¡ˆå¤§å°
            if [ -f /app/models/inswapper_128.onnx ]; then
              FILE_SIZE=\$(stat -c%s /app/models/inswapper_128.onnx 2>/dev/null || echo \"0\")
              FILE_SIZE=\${FILE_SIZE:-0}
              echo \"ğŸ“Š ä¸‹è¼‰æª”æ¡ˆå¤§å°: \$FILE_SIZE bytes\"
              
              # é©—è­‰æª”æ¡ˆå¤§å°ï¼ˆæ­£å¸¸æ‡‰è©²ç´„ç‚º 256MB = 268435456 bytesï¼‰
              if [ \$FILE_SIZE -lt 200000000 ]; then
                echo 'âŒ æª”æ¡ˆå¤ªå°ï¼Œå¯èƒ½ä¸‹è¼‰ä¸å®Œæ•´ï¼Œå˜—è©¦å‚™ç”¨ä¸‹è¼‰æº...'
                rm -f /app/models/inswapper_128.onnx
                echo 'ğŸ“¥ å˜—è©¦å¾ GitHub ä¸‹è¼‰...'
                wget --timeout=60 --tries=3 --progress=bar:force:noscroll -O /app/models/inswapper_128.onnx 'https://github.com/facefusion/facefusion-assets/releases/download/models/inswapper_128.onnx'
                if [ -f /app/models/inswapper_128.onnx ]; then
                  FILE_SIZE=\$(stat -c%s /app/models/inswapper_128.onnx 2>/dev/null || echo \"0\")
                  FILE_SIZE=\${FILE_SIZE:-0}
                  echo \"ğŸ“Š å‚™ç”¨æºæª”æ¡ˆå¤§å°: \$FILE_SIZE bytes\"
                }
              }
            }
          else
            echo 'âŒ ç¬¬ä¸€å€‹ä¸‹è¼‰æºå¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨ä¸‹è¼‰æº...'
            echo 'ğŸ“¥ å˜—è©¦å¾ GitHub ä¸‹è¼‰...'
            wget --timeout=60 --tries=3 --progress=bar:force:noscroll -O /app/models/inswapper_128.onnx 'https://github.com/facefusion/facefusion-assets/releases/download/models/inswapper_128.onnx'
            if [ -f /app/models/inswapper_128.onnx ]; then
              FILE_SIZE=\$(stat -c%s /app/models/inswapper_128.onnx 2>/dev/null || echo \"0\")
              FILE_SIZE=\${FILE_SIZE:-0}
              echo \"ğŸ“Š å‚™ç”¨æºæª”æ¡ˆå¤§å°: \$FILE_SIZE bytes\"
            }
          }
          
          # æœ€çµ‚é©—è­‰
          if [ -f /app/models/inswapper_128.onnx ]; then
            FILE_SIZE=\$(stat -c%s /app/models/inswapper_128.onnx 2>/dev/null || echo \"0\")
            FILE_SIZE=\${FILE_SIZE:-0}
            if [ \$FILE_SIZE -lt 200000000 ]; then
              echo 'âŒ æ‰€æœ‰ä¸‹è¼‰æºéƒ½å¤±æ•—æˆ–æª”æ¡ˆæå£ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥'
              rm -f /app/models/inswapper_128.onnx
              exit 1
            else
              echo \"âœ… AI æ¨¡å‹ä¸‹è¼‰æˆåŠŸï¼æª”æ¡ˆå¤§å°: \$FILE_SIZE bytes\"
              # å˜—è©¦é©—è­‰æª”æ¡ˆæ˜¯å¦ç‚ºæœ‰æ•ˆçš„ ONNX æª”æ¡ˆ
              if python3 -c \"import onnx; onnx.load('/app/models/inswapper_128.onnx'); print('âœ… ONNX æª”æ¡ˆæ ¼å¼é©—è­‰é€šé')\" 2>/dev/null; then
                echo 'âœ… æ¨¡å‹æª”æ¡ˆé©—è­‰å®Œæˆ'
              else
                echo 'âš ï¸  ç„¡æ³•é©—è­‰ ONNX æ ¼å¼ï¼Œä½†æª”æ¡ˆå¤§å°æ­£å¸¸'
              }
            }
          else
            echo 'âŒ æ¨¡å‹æª”æ¡ˆä¸‹è¼‰å¤±æ•—'
            exit 1
          }
          
          ls -lh /app/models/inswapper_128.onnx
        else
          echo 'âœ… AI æ¨¡å‹å·²å­˜åœ¨ï¼Œè·³éä¸‹è¼‰'
          if [ -f /app/models/inswapper_128.onnx ]; then
            FILE_SIZE=\$(stat -c%s /app/models/inswapper_128.onnx 2>/dev/null || echo \"0\")
            FILE_SIZE=\${FILE_SIZE:-0}
            echo \"ğŸ“Š ç¾æœ‰æª”æ¡ˆå¤§å°: \$FILE_SIZE bytes\"
            ls -lh /app/models/inswapper_128.onnx
          else
            echo 'âš ï¸  æ¨¡å‹æª”æ¡ˆä¸å­˜åœ¨ï¼Œä½†ç›®éŒ„æª¢æŸ¥é¡¯ç¤ºå­˜åœ¨'
          }
        }
      "
    restart: "no"

  # SSLæ†‘è­‰åˆå§‹åŒ–æœå‹™
  ssl-init:
    image: alpine:latest
    container_name: ai-face-swap-ssl-init
    volumes:
      - ./ssl:/ssl
    environment:
      - HOST_IP=${HOST_IP:-localhost}
      - DOMAIN_NAME=${DOMAIN_NAME:-localhost}
      - SSL_COUNTRY=${SSL_COUNTRY:-TW}
      - SSL_STATE=${SSL_STATE:-Taiwan}
      - SSL_CITY=${SSL_CITY:-Taipei}
      - SSL_ORG=${SSL_ORG:-Dev}
      - SSL_DAYS=${SSL_DAYS:-365}
    command: >
      sh -c "
        apk add --no-cache openssl &&
        echo 'ğŸ” æ­£åœ¨æª¢æŸ¥SSLæ†‘è­‰...' &&
        mkdir -p /ssl &&
        if [ ! -f /ssl/nginx-selfsigned.key ]; then
          echo 'ğŸ”„ ç”Ÿæˆç§é‘°...' &&
          openssl genrsa -out /ssl/nginx-selfsigned.key 2048;
        fi &&
        if [ ! -f /ssl/nginx-selfsigned.crt ] || ! openssl x509 -in /ssl/nginx-selfsigned.crt -text -noout | grep -q \"\$HOST_IP\"; then
          echo 'ğŸ”„ ç”ŸæˆSSLæ†‘è­‰...' &&
          SAN=\"DNS:localhost,DNS:\$DOMAIN_NAME\" &&
          if [ \"\$HOST_IP\" != \"localhost\" ] && [ \"\$HOST_IP\" != \"\$DOMAIN_NAME\" ]; then
            if echo \"\$HOST_IP\" | grep -E '^[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+\$' > /dev/null; then
              SAN=\"\$SAN,IP:\$HOST_IP\";
            else
              SAN=\"\$SAN,DNS:\$HOST_IP\";
            fi;
          fi &&
          openssl req -new -x509 -key /ssl/nginx-selfsigned.key -out /ssl/nginx-selfsigned.crt -days \$SSL_DAYS -subj \"/C=\$SSL_COUNTRY/ST=\$SSL_STATE/L=\$SSL_CITY/O=\$SSL_ORG/CN=\$DOMAIN_NAME\" -addext \"subjectAltName=\$SAN\" &&
          echo 'âœ… SSLæ†‘è­‰ç”Ÿæˆå®Œæˆ';
        else
          echo 'âœ… SSLæ†‘è­‰å·²å­˜åœ¨ä¸”æœ‰æ•ˆ';
        fi &&
        chmod 600 /ssl/nginx-selfsigned.key &&
        chmod 644 /ssl/nginx-selfsigned.crt &&
        echo 'ğŸš€ SSLæ†‘è­‰æº–å‚™å®Œæˆï¼'
      "
    restart: "no"

  frontend:
    image: docker.io/library/nginx:alpine
    container_name: ai-face-swap-frontend
    ports:
      - "8881:80"   # HTTP (é‡å®šå‘åˆ°HTTPS)
      - "8882:443"  # HTTPS (ç¶­æŒåŸæœ‰çš„å°å¤–port)
    volumes:
      - ./frontend:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/nginx.conf
      # SSLæ†‘è­‰ç›®éŒ„
      - ./ssl:/etc/ssl/certs:ro
      - ./ssl:/etc/ssl/private:ro
    environment:
      - HOST_IP=${HOST_IP:-localhost}
      - DOMAIN_NAME=${DOMAIN_NAME:-localhost}
    depends_on:
      - backend
      - ssl-init
    restart: unless-stopped

  backend:
    build:
      context: .
      dockerfile: Dockerfile.gpu  # ä½¿ç”¨GPUç‰ˆæœ¬çš„Dockerfile
    container_name: ai-face-swap-backend-gpu
    expose:
      - "3001"
    volumes:
      - ./backend:/app
    depends_on:
      - model-downloader
    restart: unless-stopped
    # GPUé…ç½®
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - PYTHONPATH=/app
      - ENVIRONMENT=development
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    command: ["python", "-m", "uvicorn", "app:app", "--host", "0.0.0.0", "--port", "3001", "--reload"]

networks:
  default:
    name: ai-avatar-studio-network